package com.example.bluetoothvulnerabilityscanner;

import androidx.annotation.NonNull;
import androidx.appcompat.app.AppCompatActivity;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;

import android.content.Context;
import android.content.Intent;
import android.graphics.Color;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.widget.Button;
import android.widget.RadioButton;
import android.widget.RadioGroup;
import android.widget.SearchView;
import android.widget.TextView;

import com.google.firebase.database.DataSnapshot;
import com.google.firebase.database.DatabaseError;
import com.google.firebase.database.DatabaseReference;
import com.google.firebase.database.FirebaseDatabase;
import com.google.firebase.database.ValueEventListener;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;

public class SearchDevices extends AppCompatActivity implements AdapterSearchDevice.OnItemListener {

    private DatabaseReference UserEntryDatabase;
    AdapterSearchDevice adapterSearchDevice;
    ArrayList<DataSearchDevice> list;
    ArrayList<DataSearchDevice> searchedList;
    RecyclerView recyclerView;
    SearchView searchView;
    RadioGroup radioGroup;
    RadioButton radioButton;
    Button buttonalphabet;
    Button buttondate;
    Button buttonvulnerabilitycount;
    Context context = this;
    String deviceName;


    String AlphabetClick;
    String DateClick;
    String VulnerabilityCountClick;


    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_search_devices);
        setTitle("Search Devices");

//        searchDeviceAdapter = new SearchDeviceAdapter(context, list, this);

        FirebaseDatabase database = FirebaseDatabase.getInstance("https://bluetoothvulnscannerdb-default-rtdb.asia-southeast1.firebasedatabase.app");
        UserEntryDatabase = database.getReference("User_Entry");

        recyclerView = findViewById(R.id.deviceRecycleView);
        recyclerView.setHasFixedSize(true);
        recyclerView.setLayoutManager(new LinearLayoutManager(context));

        searchView = findViewById(R.id.deviceSearchView);

//        radioGroup = findViewById(R.id.radioGroup);

        buttonalphabet = findViewById(R.id.sortbyalphabet);
        buttondate = findViewById(R.id.sortbydate);
        buttonvulnerabilitycount = findViewById(R.id.sortbyvulnerabilitycount);


        list = new ArrayList<>();

        Intent intent = getIntent();
        deviceName = intent.getStringExtra("deviceName");

        AlphabetClick = buttonalphabet.getText().toString();
        DateClick = buttondate.getText().toString();
        VulnerabilityCountClick = buttonvulnerabilitycount.getText().toString();


//        if(deviceName!=null || deviceName.equals("null")){
//            search(deviceName);
//        }
//
//        Log.v("deviceName", deviceName);



        //item adapter
//        searchDeviceAdapter = new SearchDeviceAdapter(context, list, this);
//        recyclerView.setAdapter(searchDeviceAdapter);

        buttonalphabet.setOnClickListener(new View.OnClickListener() {

            @Override
            public void onClick(View view) {

                AlphabetClick = buttonalphabet.getText().toString();

                if (AlphabetClick.equals("A-Z")) {

                    buttonalphabet.setText("Z-A");
                        Collections.sort(searchedList, new Comparator<DataSearchDevice>() {
                            @Override

                            public int compare(DataSearchDevice dataSearchDevice, DataSearchDevice t1) {
                                return t1.getManufacturerModel().compareTo(dataSearchDevice.getManufacturerModel());

                            }
                        });

                        adapterSearchDevice.notifyDataSetChanged();

                    }else if(AlphabetClick.equals("Z-A")){

                    buttonalphabet.setText("A-Z");

                    Collections.sort(searchedList, new Comparator<DataSearchDevice>() {
                        @Override
                        public int compare(DataSearchDevice dataSearchDevice, DataSearchDevice t1) {
                            return dataSearchDevice.getManufacturerModel().compareTo(t1.getManufacturerModel());
                        }
                    });

                    adapterSearchDevice.notifyDataSetChanged();
                }
            }
        });

        buttondate.setOnClickListener(new View.OnClickListener() {

            @Override
            public void onClick(View view) {

                DateClick = buttondate.getText().toString();

                if (DateClick.equals("Newest")) {

                    buttondate.setText("Oldest");
                    Collections.sort(searchedList, new Comparator<DataSearchDevice>() {
                        @Override
                        public int compare(DataSearchDevice dataSearchDevice, DataSearchDevice t1) {

                            String date1 = dataSearchDevice.getDate();

                            //call function to convert alphabetical date to numeric date
                            date1 = dateconverter(date1);

                            String date2 = t1.getDate();
                            date2 = dateconverter(date2);

                            return date1.compareTo(date2);
                        }
                    });

                    adapterSearchDevice.notifyDataSetChanged();

                }else if(DateClick.equals("Oldest")){

                    buttondate.setText("Newest");

                    Collections.sort(searchedList, new Comparator<DataSearchDevice>() {
                        @Override

                        public int compare(DataSearchDevice dataSearchDevice, DataSearchDevice t1) {
                            String date1 = dataSearchDevice.getDate();

                            //call function to convert alphabetical date to numeric date
                            date1 = dateconverter(date1);

                            String date2 = t1.getDate();
                            date2 = dateconverter(date2);

                            return date2.compareTo(date1);

                        }
                    });

                    adapterSearchDevice.notifyDataSetChanged();
                }
            }
        });

        buttonvulnerabilitycount.setOnClickListener(new View.OnClickListener() {

            @Override
            public void onClick(View view) {

                VulnerabilityCountClick = buttonvulnerabilitycount.getText().toString();

                if (VulnerabilityCountClick.equals("Highest")) {

                    buttonvulnerabilitycount.setText("Lowest");
                    Collections.sort(searchedList, new Comparator<DataSearchDevice>() {
                        @Override
                        public int compare(DataSearchDevice dataSearchDevice, DataSearchDevice t1) {
                            return dataSearchDevice.getVulnerabilities().compareTo(t1.getVulnerabilities());
                        }
                    });

                    adapterSearchDevice.notifyDataSetChanged();

                }else if(VulnerabilityCountClick.equals("Lowest")){

                    buttonvulnerabilitycount.setText("Highest");

                    Collections.sort(searchedList, new Comparator<DataSearchDevice>() {
                        @Override
                        public int compare(DataSearchDevice dataSearchDevice, DataSearchDevice t1) {
                            return t1.getVulnerabilities().compareTo(dataSearchDevice.getVulnerabilities());
                        }
                    });

                    adapterSearchDevice.notifyDataSetChanged();
                }
            }
        });



    }

    @Override

    protected void onStart() {
        super.onStart();

        //get all the data of User Entries.
        if (UserEntryDatabase != null) {
            UserEntryDatabase.addValueEventListener(new ValueEventListener() {

                @Override
                public void onDataChange(@NonNull DataSnapshot snapshot) {
                    if (snapshot.exists()) {

                        list = new ArrayList<>();

                        for (DataSnapshot ds : snapshot.getChildren()) {

//                            String brand = ds.child("brand").getValue(String.class);
                            String userSubmissionID = ds.getKey();
                            String manufacturer = ds.child("manufacturer").getValue(String.class);
                            String model = ds.child("model").getValue(String.class);

                            String manufacturerdmodel = manufacturer + " " + model;
                            String androidversion = ds.child("release").getValue(String.class);
                            String chipset = ds.child("chipset").getValue(String.class);

                            String socmodel = ds.child("socmodel").getValue(String.class);
                            String socmanufacturer = ds.child("socmanufacturer").getValue(String.class);

                            String socmanufacturermodel = socmodel + ", " + socmanufacturer;

                            if (chipset.equals("unknown")){chipset = socmanufacturermodel;}

                            String dateofscan = ds.child("date").getValue(String.class);

                            //default to 0 first. Will add up in the next part.
                            int vulnerabilityCount = 0;


                            //not all will have vulnerabilities as such default as 0 above.
                            DataSnapshot Branch = ds.child("vulnerabilities");

                            Long vulnerabilityCountHolder = Branch.getChildrenCount();

                            vulnerabilityCount = vulnerabilityCountHolder.intValue();


                            list.add(new DataSearchDevice(userSubmissionID, manufacturerdmodel, androidversion, chipset, dateofscan, vulnerabilityCount));

                        }

                        if(deviceName==null){
                            //fill up the searched array with values by searching something.
                            String searchText = "";
                            search(searchText);

                        }else{
                            String searchText = deviceName;
                            search(searchText);
                            Log.v("deviceNameOnStart", deviceName);
                        }
                    }

                }

                @Override
                public void onCancelled(@NonNull DatabaseError error) {
                    Log.d("SearchDevices", "DATABASE ERROR", error.toException());
                }
            });

        }


        if (searchView != null) {

            searchView.setOnQueryTextListener(new SearchView.OnQueryTextListener() {
                @Override
                public boolean onQueryTextSubmit(String searchText) {
                    return false;
                }

                @Override
                public boolean onQueryTextChange(String searchText) {

                    //searchText can never be null at the start to prevent errors
                    if (searchText.equals(null)){
                    searchText = "";
                    }

                    search(searchText);
                    return true;
                }
            });
        }

    }

    @Override
    public void onItemClick(int position) {

        String userSubmissionID = searchedList.get(position).getuserSubmissionID();

        Log.d("onItemClick", userSubmissionID);

        Intent intent = new Intent(context, SearchDeviceResult.class);
        intent.putExtra("userSubmissionID", userSubmissionID);
        startActivity(intent);

    }



    public void search(String searchText) {

        Log.v("SEARCHFUNCTION:", "called");

        searchedList = new ArrayList<>();

        for (int i = 0; i < list.size(); i++) {

            String manufacturermodel = list.get(i).getManufacturerModel();

            if (manufacturermodel != null) {
                Log.d("manufacturermodel", manufacturermodel);

                if (manufacturermodel.toLowerCase().contains(searchText.toLowerCase())) {
                    searchedList.add(list.get(i));

                    Log.d("myListSize", String.valueOf(searchedList.size()));
                }

            } else {
                Log.d("brandmodelname", "empty");
            }
        }

        adapterSearchDevice = new AdapterSearchDevice(context, searchedList, this);
        recyclerView.setAdapter(adapterSearchDevice);
        adapterSearchDevice.notifyDataSetChanged();

        //method repeated here instead of being called such that when user is typing a keyword,
        //the sort is called again after they type the word so that the sort function applies no matter what

//        int radioId = radioGroup.getCheckedRadioButtonId();
//        radioButton = findViewById(radioId);
//        String radioButtonText = (String) radioButton.getText();
//
//        Log.d("radioButtonText", radioButtonText);
//
//        sortArrayList(radioButtonText);

    }

//    public void checkButton(View view) {
//
//        int radioId = radioGroup.getCheckedRadioButtonId();
//        radioButton = findViewById(radioId);
//        String radioButtonText = (String) radioButton.getText();
//
//        Log.d("radioButtonText", radioButtonText);
//
//        sortArrayList(radioButtonText);
//
//    }

//    private void sortArrayList(String radioButtonText) {
//
//        if (searchedList == null) {
//            search("");
//        }
//
//        if (radioButtonText.equals("A-Z")) {
//            Collections.sort(searchedList, new Comparator<DataSearchDevice>() {
//                @Override
//                public int compare(DataSearchDevice dataSearchDevice, DataSearchDevice t1) {
//                    return dataSearchDevice.getManufacturerModel().compareTo(t1.getManufacturerModel());
//                }
//            });
//
//            adapterSearchDevice.notifyDataSetChanged();
//
//        }
//
//        if (radioButtonText.equals("Z-A")) {
//            Collections.sort(searchedList, new Comparator<DataSearchDevice>() {
//                @Override
//                public int compare(DataSearchDevice dataSearchDevice, DataSearchDevice t1) {
//                    return t1.getManufacturerModel().compareTo(dataSearchDevice.getManufacturerModel());
//                }
//            });
//
//            adapterSearchDevice.notifyDataSetChanged();
//
//        }
//
//
//        if (radioButtonText.equals("Newest First")) {
//            Collections.sort(searchedList, new Comparator<DataSearchDevice>() {
//                @Override
//
//                public int compare(DataSearchDevice dataSearchDevice, DataSearchDevice t1) {
//                    String date1 = dataSearchDevice.getDate();
//
//                    //call function to convert alphabetical date to numeric date
//                    date1 = dateconverter(date1);
//
//                    String date2 = t1.getDate();
//                    date2 = dateconverter(date2);
//
//                    return date2.compareTo(date1);
//                }
//            });
//
//
//
//            adapterSearchDevice.notifyDataSetChanged();
//
//        }
//
//        if (radioButtonText.equals("Oldest First")) {
//            Collections.sort(searchedList, new Comparator<DataSearchDevice>() {
//                @Override
//                public int compare(DataSearchDevice dataSearchDevice, DataSearchDevice t1) {
//
//                    String date1 = dataSearchDevice.getDate();
//
//                    //call function to convert alphabetical date to numeric date
//                    date1 = dateconverter(date1);
//
//                    String date2 = t1.getDate();
//                    date2 = dateconverter(date2);
//
//                    return date1.compareTo(date2);
//                }
//            });
//
//            adapterSearchDevice.notifyDataSetChanged();
//
//        }
//
//
//
//    }

    public String dateconverter(String date) {

        //default epoch time
        String datenumeric =  "19700101000000";

        if(date!=null) {

            String datetime = date.substring(11, 13) + date.substring(14, 16) + date.substring(17, 19);
            String datedate = date.substring(8, 10);
            String datemonth = date.substring(4, 7).toLowerCase();
            String dateyear = date.substring(date.length() - 4);

            if (datemonth.equals("jan")) {
                datemonth = "01";

            } else if (datemonth.equals("feb")) {
                datemonth = "02";

            } else if (datemonth.equals("mar")) {
                datemonth = "03";

            } else if (datemonth.equals("april")) {
                datemonth = "04";

            } else if (datemonth.equals("may")) {
                datemonth = "05";

            } else if (datemonth.equals("june")) {
                datemonth = "06";

            } else if (datemonth.equals("july")) {
                datemonth = "07";

            } else if (datemonth.equals("aug")) {
                datemonth = "08";

            } else if (datemonth.equals("sep")) {
                datemonth = "09";

            } else if (datemonth.equals("oct")) {
                datemonth = "10";

            } else if (datemonth.equals("nov")) {
                datemonth = "11";

            } else if (datemonth.equals("dec")) {
                datemonth = "12";

            } else {
                datemonth = "error";
            }

            datenumeric = dateyear + datemonth + datedate + datetime;

            return datenumeric;
        }

        return datenumeric;
    }
}





