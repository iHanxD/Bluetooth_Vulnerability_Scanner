package com.example.bluetoothvulnerabilityscanner;

import android.content.Context;
import android.content.Intent;
import android.os.Bundle;

import androidx.fragment.app.Fragment;
import androidx.lifecycle.ViewModelProvider;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;

import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.TextView;
import android.widget.Toast;


import org.w3c.dom.Text;

import java.util.ArrayList;
import java.util.HashMap;

///**
// * A simple {@link Fragment} subclass.
// * Use the {@link fragment2#newInstance} factory method to
// * create an instance of this fragment.
// */

public class fragment2 extends Fragment implements ItemAdapter.OnItemListener {


    View root;
    Context thiscontext;
    RecyclerView recyclerView;
    TextView resultTitle;
    TextView resultQuantityTitle;
    TextView vulnerabilitiesTitle;
    TextView scoreTitle;

    ItemAdapter itemAdapter;
    ArrayList<ItemData> list;

    ArrayList<HashMap<String, String>> cveInfo = new ArrayList<HashMap<String, String>>();


    @Override
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

//        if (getArguments() != null) {
//            mParam1 = getArguments().getString(ARG_PARAM1);
//            mParam2 = getArguments().getString(ARG_PARAM2);
//        }
    }

    @Override
    public View onCreateView(LayoutInflater inflater, ViewGroup container,
                             Bundle savedInstanceState) {

        // Inflate the layout for this fragment
        root = inflater.inflate(R.layout.fragment_fragment2, container, false);

        //getting information from ScanDevice activity
        ScanDevice activity = (ScanDevice) getActivity();

        thiscontext = container.getContext();

        recyclerView = root.findViewById(R.id.cveList);
        recyclerView.setHasFixedSize(true);
        recyclerView.setLayoutManager(new LinearLayoutManager(thiscontext));

        list = new ArrayList<>();
        itemAdapter = new ItemAdapter(thiscontext, list, this);
        recyclerView.setAdapter(itemAdapter);



        Button scanDeviceButton = (Button) root.findViewById(R.id.scanDevice);
        scanDeviceButton.setOnClickListener(new View.OnClickListener(){

            int i = 0;

            @Override
            public void onClick(View view) {

                //counter to see how many times user pressed. they can only press it once.
                if(i==0){
                    cveInfo = activity.cveInfo;

                    resultTitle = root.findViewById(R.id.resultTitle);
                    resultQuantityTitle = root.findViewById(R.id.resultQuantityTitle);
                    vulnerabilitiesTitle = root.findViewById(R.id.vulnerabilitiesTitle);
                    scoreTitle = root.findViewById(R.id.scoreTitle);

                    if(cveInfo.size()>0) {
                        resultTitle.setText("Vulnerable: YES");
                        resultQuantityTitle.setText("Detected Vulnerabilities: " + String.valueOf(cveInfo.size()));
                        vulnerabilitiesTitle.setText("Vulnerabilities");
                        scoreTitle.setText("Base Score");


                        for(int i=0; i< cveInfo.size(); i++){

                            String cveName = cveInfo.get(i).get("cveName");
                            String baseScore = cveInfo.get(i).get("baseScore");

                            list.add(new ItemData(cveName, baseScore));

                            Log.v("fragment12", cveName + ", " + baseScore);
                        }

                    }else{

                        resultTitle.setText("Vulnerable: NO");
                        resultQuantityTitle.setText("Detected Vulnerabilities: " + String.valueOf(cveInfo.size()));

                    }



//                Log.v("fragment23", String.valueOf(cveInfo.size()));

                    itemAdapter.notifyDataSetChanged();

                    i++;
                }
            }
        });


        return root;
    }

    @Override
    public void onItemClick(int position) {

        String cveName = cveInfo.get(position).get("cveName");

        Log.d("onItemClick", cveName);

        Intent intent = new Intent(thiscontext, CveInfo.class);
        intent.putExtra("cveName",  cveName);
        startActivity(intent);

    }
}